CREATE OR REPLACE PROCEDURE SYSTEM.EXP_DIAG_ERR (period VARCHAR2, s_glpu VARCHAR2)
  IS
  PRAGMA autonomous_transaction;

  idpacs ut.id_pac%type;
  idsluch ut.id_sluch%type;
  idserv ut.idserv%type;
  mcod ut.lpu_1%type;
  cd_usl ut.CODE_USL%type;

  query VARCHAR2(1000);
  TYPE EmpCurTyp IS REF CURSOR;
  cur EmpCurTyp;

  dot VARCHAR2(1);
BEGIN

  dot := '.';

  query := 'SELECT ut.id_pac, ut.id_sluch, ut.idserv, ut.lpu_1
              FROM '||period||' ut
              WHERE ut.lpu = '||''''||s_glpu||''' AND
                  REPLACE(TRIM(ut.DS), '''||dot||''') NOT IN (SELECT TRIM(h.CODE) FROM HEDIAG h) AND
                  ut.id_pac||ut.LPU NOT IN (SELECT s.ID_PAC||s.GLPU
                                                 FROM SANKC s
                                                 WHERE s.glpu = '||''''||s_glpu||''' AND s.period = '||''''||SUBSTR(period, -6, 6)||''')';

  DBMS_OUTPUT.PUT_LINE(query);

  OPEN cur for query;
  LOOP
    FETCH cur INTO idpacs, idsluch, idserv, mcod;
      EXIT WHEN cur%NOTFOUND;

      INSERT INTO SANKC (glpu, mcod, povod, flag, ID_PAC, id_sluch, idserv, DATE_EXP, period)
          VALUES (s_glpu, mcod, '5.1.4.', 5, idpacs, idsluch, idserv, SYSDATE, SUBSTR(period, -6, 6));

  END LOOP;
  CLOSE cur;
  COMMIT;

END;
/