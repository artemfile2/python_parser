CREATE OR REPLACE PROCEDURE SYSTEM.EXP_DB_ERR (period VARCHAR2, s_glpu VARCHAR2)
IS
  pragma autonomous_transaction;

  idpacs ut.id_pac%type;
  idsluch ut.id_sluch%type;
  idserv ut.idserv%type;
  mcod ut.lpu_1%type;
  summv ut.SUMV_USL%type;
  cd_usl ut.CODE_USL%type;
  identsp pt.IDENT_SP%TYPE;

  query3 VARCHAR2(1400);
  TYPE EmpCurTyp IS REF CURSOR;
  cur3 EmpCurTyp;
BEGIN

  query3 := 'SELECT distinct(ut.id_sluch) as id_sluch, ut.id_pac, ut.lpu_1, SUM(ut.SUMV_USL) AS summv,
                MAX(ut.idserv) AS idserv, cur.IDENT_SP
                FROM UT05S50'||SUBSTR(period, -6, 6)||' ut
                INNER JOIN ( SELECT ps.ID_PAC, ps.IDENT_SP
                               FROM '||period||' ps
                               WHERE ps.glpu = '||''''||s_glpu||''' AND
                                   ps.IDENT_SP IS NOT NULL AND
                                   ps.id_pac||ps.GLPU NOT IN (SELECT s.ID_PAC||s.GLPU
                                                                 FROM SANKC s
                                                                 WHERE s.glpu = '||''''||s_glpu||''' AND
                                                                       s.period = '||''''||SUBSTR(period, -6, 6)||''')) cur
                  ON ut.ID_PAC = cur.ID_PAC
                  GROUP BY ut.id_sluch, ut.id_pac, ut.lpu_1, cur.IDENT_SP
                  ORDER BY ut.ID_PAC';

 OPEN cur3 for query3;
  LOOP
    FETCH cur3 INTO idsluch, idpacs, mcod, summv, idserv, identsp;
      EXIT WHEN cur3%NOTFOUND;

      IF identsp = 0 THEN
          INSERT INTO SANKC (glpu, mcod, povod, flag, ID_PAC, id_sluch, idserv, DATE_EXP, period, comments, summ_shtr)
              VALUES (s_glpu, 'mcod', '5.2.2.', 2, idpacs, idsluch, idserv, SYSDATE, SUBSTR(period,-6,6), 'НЕ НАЙДЕН В БД СРЗ', summv);
          COMMIT;
      ELSIF identsp = 2 THEN
          INSERT INTO SANKC (glpu, mcod, povod, flag, ID_PAC, id_sluch, idserv, DATE_EXP, period, comments, summ_shtr)
              VALUES (s_glpu, 'mcod', '5.2.2.', 3, idpacs, idsluch, idserv, SYSDATE, SUBSTR(period,-6,6), 'НЕВЕРНЫЙ КОД СМО', summv);
          COMMIT;
      END IF;

  END LOOP;
  CLOSE cur3;


END;
/